<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Image Editor - Bikaner Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #007bff; margin-top: 0; }
        .upload-section { border: 3px dashed #007bff; padding: 40px; text-align: center; cursor: pointer; border-radius: 12px; background: #f8fbff; transition: 0.3s; }
        .upload-section:hover { background: #eef5ff; border-color: #0056b3; }
        .editor-layout { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px; }
        .preview-area { flex: 1.5; min-width: 350px; background: #222; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 400px; }
        .controls { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
        .control-group { background: #ffffff; padding: 15px; border-radius: 10px; border: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        label { font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px; color: #555; }
        input, select, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 14px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:hover { background: #0056b3; }
        #downloadBtn { background: #28a745; display: none; }
        #downloadBtn:hover { background: #218838; }
        #status { font-weight: bold; text-align: center; padding: 10px; border-radius: 5px; }
        img { max-width: 100%; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¸ Universal Image Master</h2>
    
    <div class="upload-section" onclick="document.getElementById('fileInput').click()">
        <p id="uploadText"><strong>Drag & Drop</strong> ya yahan click karke photo select karein</p>
        <input type="file" id="fileInput" hidden accept="image/*">
    </div>

    <div class="editor-layout" id="mainEditor" style="display: none;">
        <div class="preview-area">
            <img id="imageDisplay">
        </div>

        <div class="controls">
            <div class="control-group">
                <label>File Format (Kis type mein chahiye?)</label>
                <select id="formatSelect">
                    <option value="image/jpeg">JPEG (.jpg)</option>
                    <option value="image/png">PNG (.png)</option>
                    <option value="image/webp">WebP (.webp)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Target Size (Max KB mein)</label>
                <input type="number" id="targetSize" placeholder="Example: 50" min="1">
                <small style="color: #888;">Note: Ye exact target se thoda niche hi rakhega safety ke liye.</small>
            </div>

            <div class="control-group">
                <label>Manual Dimensions (Optional)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="number" id="resizeW" placeholder="Width (px)">
                    <input type="number" id="resizeH" placeholder="Height (px)">
                </div>
            </div>

            <button onclick="processImage()">Apply & Process Image</button>
            <button id="downloadBtn" onclick="downloadFinalImage()">ðŸ“¥ Download Processed Image</button>
            <div id="status"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    let cropper;
    let originalFileName;
    const fileInput = document.getElementById('fileInput');
    const imageDisplay = document.getElementById('imageDisplay');
    const mainEditor = document.getElementById('mainEditor');
    const status = document.getElementById('status');

    // Image Upload Handling
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            originalFileName = file.name.split('.')[0];
            const reader = new FileReader();
            reader.onload = () => {
                imageDisplay.src = reader.result;
                mainEditor.style.display = 'flex';
                if (cropper) cropper.destroy();
                // Initialize Cropper
                cropper = new Cropper(imageDisplay, { 
                    aspectRatio: NaN, 
                    viewMode: 1,
                    autoCropArea: 1 
                });
                status.innerText = "";
                document.getElementById('downloadBtn').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    };

    async function processImage() {
        if (!cropper) return;

        const format = document.getElementById('formatSelect').value;
        const targetSizeKB = parseFloat(document.getElementById('targetSize').value);
        const manualW = document.getElementById('resizeW').value;
        const manualH = document.getElementById('resizeH').value;

        status.style.color = "#007bff";
        status.innerText = "â³ Processing... Size adjust ho raha hai.";

        // 1. Get Cropped Canvas
        let canvas = cropper.getCroppedCanvas({
            width: manualW || undefined,
            height: manualH || undefined
        });

        let quality = 0.98; // Start with high quality
        let scale = 1.0;
        let finalBlob;
        let currentSize = Infinity;

        // 2. Precision Loop (2% steps for accuracy)
        if (targetSizeKB) {
            while (currentSize > targetSizeKB && (quality > 0.1 || scale > 0.1)) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = Math.floor(canvas.width * scale);
                tempCanvas.height = Math.floor(canvas.height * scale);
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

                finalBlob = await new Promise(resolve => tempCanvas.toBlob(resolve, format, quality));
                currentSize = finalBlob.size / 1024;

                // Step strategy: Reduce quality slowly, then scale if needed
                if (quality > 0.3) {
                    quality -= 0.05; // 5% reduction per step
                } else {
                    scale -= 0.1;   // Reduce resolution
                    quality = 0.7;  // Reset quality for new scale
                }
            }
        } else {
            finalBlob = await new Promise(resolve => canvas.toBlob(resolve, format, 0.9));
        }

        // 3. Result Output
        if (finalBlob) {
            const finalUrl = URL.createObjectURL(finalBlob);
            window.finalUrl = finalUrl;
            window.finalFormat = format.split('/')[1];
            
            document.getElementById('downloadBtn').style.display = 'block';
            status.style.color = "#28a745";
            status.innerText = `âœ… Done! Final Size: ${(finalBlob.size / 1024).toFixed(2)} KB`;
        }
    }

    function downloadFinalImage() {
        const link = document.createElement('a');
        link.href = window.finalUrl;
        link.download = `${originalFileName}_processed.${window.finalFormat}`;
        link.click();
    }
</script>

</body>
</html>
